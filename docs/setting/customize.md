# 設定／カスタマイズ

INIファイル内の設定を変更することで、動作変更が可能。

## 麻雀ルール調整

### mahjongセクション

|     キー      |        内容        |               型                |    省略時     |                      備考                      |
| ------------- | ------------------ | ------------------------------- | ------------- | ---------------------------------------------- |
| rule_version  | ルール識別子       | 文字列                          | 空欄          | 別ルールで打った時に区別できるようにする識別子 |
| point         | 持ち点             | 数値(100点単位)                 | 250           | 配給原点                                       |
| return        | 返し点             | 数値(100点単位)                 | 300           | オカ                                           |
| rank_point    | 順位点             | カンマ区切り数値4つ(1000点単位) | 30,10,-10,-30 | 1位から順に4つ並べる                           |
| ignore_flying | 箱下のカウント表示 | 真偽値                          | False         | `True` : トビ終了の表示をなくす                |
| draw_split    | 順位点の山分け     | 真偽値                          | False         | `True` : 素点同点時に順位点を山分けする        |


### regulationsセクション

定義されているキーが [`words` テーブル](../datedase/schema.md#typeの種別)の`word`として事前登録される。</br>
アプリケーション起動時にテーブルの内容は毎回再定義される。

|          キー          |                  内容                  |                型                | 省略時 |                      備考                      |
| ---------------------- | -------------------------------------- | -------------------------------- | ------ | ---------------------------------------------- |
| undefined              | 未定義の単語の取り扱い                 | 数値(`0`or`2`)                   | 2      | typeを指定                                     |
| yakuman                | 事前登録ワード(役満)                   | 文字列(カンマ区切り)             | None   | `word` に `type=0` として登録(`type0`と同義)   |
| type0                  | 事前登録ワード(役満)                   | 文字列(カンマ区切り)             | None   | `word` に `type=0` として登録(`yakuman`と同義) |
| type2                  | 事前登録個別ワード                     | 文字列(カンマ区切り)             | None   | `word` に `type=2` として登録                  |
| その他（任意のワード） | `type=1`として登録される事前登録ワード | 数値(追加計算される卓外ポイント) |        | キーを単語として登録</br>ポイントは1000点単位  |

<details>
<summary>type1の設定例</summary>

```
[regulations]
卓外ペナルティ = -20
```

</details>

## アプリケーション設定

### settingセクション

|     キー      |                      内容                       |           型           |    省略時    |                                                   備考                                                   |
| ------------- | ----------------------------------------------- | ---------------------- | ------------ | -------------------------------------------------------------------------------------------------------- |
| slash_command | スラッシュコマンド名                            | 文字列                 | /mahjong     | 先頭のスラッシュも含める                                                                                 |
| guest_mark    | ゲストに付ける記号                              | 文字列                 | ※           |                                                                                                          |
| thread_report | スレッド内にある成績記録キーワードを処理する    | 真偽値                 | True         |                                                                                                          |
| time_adjust   | 日付変更後、指定時間までを1日単位の集計に含める | 数値                   | 12           | 時間(60分単位)で指定                                                                                     |
| reaction_ok   | 素点合計が正しい場合に付けるリアクション        | 文字列(絵文字)         | ok           | ゲーム結果のポスト、メモに対して付く                                                                     |
| reaction_ng   | 素点合計が誤っている場合に付けるリアクション    | 文字列(絵文字)         | ng           | ゲーム結果のポストに対して付く                                                                           |
| font_file     | グラフ描写に使用する日本語フォントファイル[^1]  | 文字列                 | `ipaexg.ttf` |                                                                                                          |
| graph_style   | グラフに使用するスタイル                        | 文字列                 | ggplot       | [style sheets reference](https://matplotlib.org/stable/gallery/style_sheets/style_sheets_reference.html) |
| remarks_word  | ゲーム結果にメモを残す場合に付けるキーワード    | 文字列                 | 麻雀成績メモ |                                                                                                          |
| ignore_userid | Slack検索時に投稿内容を無視するユーザID         | 文字列                 | 空欄         | 複数指定時はカンマ区切り                                                                                 |
| work_dir      | 生成ファイルの保存先[^1]                        | 文字列(ディレクトリ名) | `work`       | 画像ファイル、PDFファイルの保存先                                                                        |

> [!TIP]
> `ignore_userid`は、botが出力する内容が検索にヒットしてしまう状況でbotのIDを指定するような利用方法を想定している。

### databaseセクション

|        キー         |                   内容                    |           型           |      省略時      |              備考              |
| ------------------- | ----------------------------------------- | ---------------------- | ---------------- | ------------------------------ |
| database_file       | 成績を記録するファイル名[^1]              | 文字列(ファイル名)     | mahjong.db       | SQLite 3.x database            |
| backup_dir          | 自動バックアップ保存先[^1]                | 文字列(ディレクトリ名) | None             | 空欄時はバックアップしない     |
| channel_limitations | SQLを発行できるチャンネルID(カンマ区切り) | 文字列(channel_id)     | None             | 空欄の場合はすべてのチャンネル |
| commandword         | 突合処理呼び出しキーワード                | 文字列                 | 麻雀成績チェック |                                |

> [!TIP]
> `channel_limitations`は複数のチャンネルにbotをIntegrationsしている状態で、参照専用のチャンネルを作成するような利用方法を想定している。

## 検索オプション

### searchセクション

|  キー   |               内容               |          型          | 省略時 |                              備考                              |
| ------- | -------------------------------- | -------------------- | ------ | -------------------------------------------------------------- |
| keyword | 成績記録用キーワード             | 文字列               | 終局   |                                                                |
| channel | 突合処理時に検索されるチャンネル | 文字列(チャンネル名) | *必須* |                                                                |
| after   | データ突合開始日                 | 数値                 | 7      | 突合実行日時から指定日を引いた日                               |
| wait    | 突合処理待ち時間(秒)             | 数値                 | 180    | イベント発生時刻から待ち時間以上経過したデータのみが突合の対象 |

複数チャンネルで突合する場合は別設定のINIファイル準備し、 `dbtools.py` を利用する。

### commentセクション

|     キー     |                        内容                        |   型   | 省略時 |                 備考                 |
| ------------ | -------------------------------------------------- | ------ | ------ | ------------------------------------ |
| search_word  | キーワード「コメント」に指定文字列を常につける     | 文字列 |        | コメント検索しか行わなくなる(専用化) |
| group_length | 集約キーワードを指定しなかった場合に集約する文字数 | 数値   |        | 上書き指定可                         |

### aliasセクション

スラッシュコマンド使用時のサブコマンドの別名を定義。

|   キー   |           内容           |          型          | 省略時 |            備考            |
| -------- | ------------------------ | -------------------- | ------ | -------------------------- |
| results  | 成績表示                 | 文字列(カンマ区切り) |        |                            |
| graph    | グラフ表示               | 文字列(カンマ区切り) |        |                            |
| ranking  | ランキング表示           | 文字列(カンマ区切り) |        |                            |
| report   | レポート表示             | 文字列(カンマ区切り) |        |                            |
| check    | データベース突合         | 文字列(カンマ区切り) |        |                            |
| download | データベースダウンロード | 文字列(カンマ区切り) |        |                            |
| member   | メンバーリスト表示       | 文字列(カンマ区切り) |        |                            |
| add      | メンバー追加             | 文字列(カンマ区切り) |        | メンバー新規登録、別名登録 |
| del      | メンバー削除             | 文字列(カンマ区切り) |        | メンバー削除、別名削除     |

## 成績管理

`results` `graph` `ranking` `report` の各セクションで定義できる項目。

|         キー         |                       内容                       |   型   | 省略時 | results | graph | ranking | report |                         備考                         |
| -------------------- | ------------------------------------------------ | ------ | ------ | :-----: | :---: | :-----: | :----: | ---------------------------------------------------- |
| commandword          | チャンネル内から機能を呼び出すキー               | 文字列 |        |   〇    |  〇   |   〇    |   〇   |                                                      |
| aggregation_range    | 検索範囲未指定時のデフォルト値                   | 文字列 | 当日   |   〇    |  〇   |   〇    |   〇   |                                                      |
| unregistered_replace | 未登録プレイヤーを `guest_name` に置き換えて表示 | 真偽値 | True   |   〇    |  〇   |   〇    |        |                                                      |
| guest_skip           | 未登録プレイヤーの結果を無視する                 | 真偽値 | True   |   〇    |  〇   |   〇    |        | 全体成績用                                           |
| guest_skip2          | 未登録プレイヤーの結果を無視する                 | 真偽値 | True   |   〇    |  〇   |   〇    |        | 個人成績用                                           |
| score_comparisons    | 比較モードで表示する                             | 真偽値 | False  |         |       |         |        | 内部フラグ（`True`指定時は強制的に比較モードになる） |
| game_results         | 戦績(ゲーム単位の素点と順位)を表示               | 真偽値 | False  |         |       |         |        | 内部フラグ（`True`指定時は強制的表示 ）              |
| versus_matrix        | 対戦マトリックス表示                             | 真偽値 | False  |   〇    |       |         |   〇   | 個人成/チーム成績績専用                              |
| individual           | デフォルトの集計対象を切り替え                   | 真偽値 | True   |   〇    |  〇   |   〇    |   〇   | `True` : 個人成績<br />`False` : チーム成績          |
| statistics           | 「統計」オプションを常に指定                     | 真偽値 | False  |   〇    |       |         |        | 座席データ、レコードを常に表示する                   |
| dropitems            | 非表示にする項目を指定                           | 文字列 | None   |   〇    |       |   〇    |        | カンマ区切り                                         |
| always_argument      | コマンドに常に指定する文字列を追加               | 文字列 | 空欄   |   〇    |  〇   |   〇    |   〇   | キーで指定しているデフォルト値を上書きする           |
| stipulated           | 規定打数(指定値固定)                             | 数値   | 1      |   〇    |  〇   |   〇    |   〇   | `0`が指定されている場合は`stipulated_rate`を使う     |
| stipulated_rate      | 規定打数を集計ゲーム数よって決める               | 数値   | 0.05   |   〇    |  〇   |   〇    |   〇   | 集計ゲーム数 ×`stipulated_rate`（切り上げ）+ 1       |

以下の順に評価され、値を上書きしていく。
1. 設定ファイルからデフォルト値読み込み
1. `always_argument` の処理
1. slackから与えられた引数の処理

[日付指定](../functions/argument_keyword.md#日付指定)は指定されている範囲だけになる。
> [!TIP]
> `always_argument`で`今年`と定義した状態でslackから`今月 先月`と指定した場合の範囲は`今月 先月`となる。<br />
> slackから日付指定がない場合は`今年`が範囲になる。

## メンバー管理

### memberセクション

|        キー        |                     内容                     |   型   |    省略時    | 備考 |
| ------------------ | -------------------------------------------- | ------ | ------------ | ---- |
| commandword        | チャンネル内からmemberコマンドを呼び出すキー | 文字列 | メンバー一覧 |      |
| registration_limit | 登録メンバー数上限                           | 数値   | 255          |      |
| character_limit    | 登録メンバー名文字数上限                     | 数値   | 8            |      |
| alias_limit        | 別名登録上限                                 | 数値   | 16           |      |
| guest_name         | 未登録メンバーを置換するときの名前           | 文字列 | ゲスト       |      |

### teamセクション

|        キー        |                      内容                       |   型   |   省略時   | 備考 |
| ------------------ | ----------------------------------------------- | ------ | ---------- | ---- |
| commandword        | チャンネル内からteam_listコマンドを呼び出すキー | 文字列 | チーム一覧 |      |
| registration_limit | 登録チーム数上限                                | 数値   | 255        |      |
| character_limit    | 登録チーム名文字数上限                          | 数値   | 16         |      |
| member_limit       | チーム構成メンバー上限                          | 数値   | 16         |      |
| friendly_fire      | 同じチームが同卓しているゲームを集計対象にする  | 真偽値 | True       |      |

## 装飾オプション

### degreeセクション

プレイしたゲーム数に対して表示される称号。

|  キー   |          内容          |          値          |         備考          |
| ------- | ---------------------- | -------------------- | --------------------- |
| display | 表示するか指定         | 真偽値               |                       |
| badge   | 追加される文字列       | 文字列(カンマ区切り) | counterの数と合わせる |
| counter | 称号が変化するゲーム数 | 数値(カンマ区切り)   | badgeの数と合わせる   |

### statusセクション

勝率に対して付く調子バッジ。

|  キー   |         内容         |          値          |                            備考                             |
| ------- | -------------------- | -------------------- | ----------------------------------------------------------- |
| display | 表示するか指定       | 真偽値               |                                                             |
| badge   | 追加される文字列     | 文字列(カンマ区切り) | 休み、絶不調、不調、普通、好調、絶好調の順に6段階すべて指定 |
| step    | ステータス変動の段階 | 数値                 | 普通を基準(勝率50%)として、上下する刻み幅                   |

### gradeセクション

段位表示。

|    キー    |              内容              |   値   |           備考            |
| ---------- | ------------------------------ | ------ | ------------------------- |
| display    | 表示するか指定                 | 真偽値 |                           |
| table_name | 使用する昇段計算テーブルの名前 | 文字列 | [別表参照](gradetable.md) |

#### table_nameに指定できる内容

|         指定文字列         |             内容             |
| -------------------------- | ---------------------------- |
| mahjongsoul<br>雀魂        | 雀魂表記                     |
| tenho<br>天鳳              | 天鳳表記                     |
| その他(JSONファイル名)[^1] | オリジナル定義ファイルを使用 |

## メッセージカスタマイズオプション


### custom_messageセクション

使用シーン別のプレフィックスが付いたキーに表示メッセージを定義。

プレフィックス以降の文字列は任意。

セクション内でユニークになるように定義すること（ランダムに選択される）。

|   プレフィックス   |                                使用シーン                                 | 備考 |
| ------------------ | ------------------------------------------------------------------------- | ---- |
| invalid_argument   | オプション解析に失敗した場合                                              |      |
| invalid_score      | 持ち点合計と配給原点合計に差分がある場合                                  |      |
| no_hits            | 検索指定範囲にゲーム結果が見つからない場合                                |      |
| restricted_channel | 制限チャンネルでデータ更新をしようとした場合                              |      |
| inside_thread      | `thread_report` が `False` の場合にスレッド内で点数登録をしようとした場合 |      |

メッセージ内の特定文字列は以下のように置き換えられる。

無効な置き換え文字列が含まれている場合、 `{user_id}` 以外の文字列はそのまま表示される（置き換えは行われない）。

| 置き換え文字列 |          置き換え後の文字          |            備考             |
| -------------- | ---------------------------------- | --------------------------- |
| {user_id}      | コマンドを投入したユーザのslack id | メンションは `<@{user_id}>` |
| {rpoint_diff}  | 点数差分の絶対値                   | 配給原点 * 4 - 入力点数合計 |
| {rpoint_sum}   | 素点合計                           | 入力された点数の合計値      |
| {keyword}      | 結果記録用のキーワード             |                             |
| {start}        | 指定した検索開始日時               | `YYYY/MM/DD hh:mm`          |
| {end}          | 指定した検索終了日時               | `YYYY/MM/DD hh:mm`          |

[^1]: 設定ファイルからの相対パスで指定
